<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TaiStat Learning Platform</title>

  <!-- Favicons (Optional) -->
  <link rel="icon" type="image/svg+xml" href="tailogo.png" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <!-- Main CSS -->
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
    }
    body {
      background-color: #f9f9f9;
      color: #333;
    }
    /* Header */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background-color: #fff;
      padding: 10px 20px;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo {
      font-size: 1.4rem;
      font-weight: 700;
      color: #333;
      text-decoration: none;
    }
    .search-bar {
      position: relative;
      flex: 1;
      max-width: 300px;
    }
    .search-bar input {
      width: 100%;
      padding: 8px 30px 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .search-bar i {
      position: absolute;
      right: 10px;
      top: 8px;
      color: #aaa;
    }
    .profile-icon {
      min-width: 40px;
      height: 40px;
      background-color: #6c63ff;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .profile-icon:hover {
      background-color: #5548d1;
    }
    /* Layout: 3 columns */
    .container {
      display: flex;
      flex-direction: row;
      gap: 20px;
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    /* Left Sidebar (Courses List) */
    .sidebar-left {
      width: 250px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      height: fit-content;
    }
    .sidebar-left h3 {
      font-size: 1rem;
      margin-bottom: 15px;
      font-weight: 700;
    }
    .sidebar-left ul {
      list-style: none;
    }
    .sidebar-left ul li {
      margin: 10px 0;
      font-size: 0.95rem;
      cursor: pointer;
      color: #555;
    }
    .sidebar-left ul li:hover {
      color: #6c63ff;
    }
    /* Main Content / Dashboard */
    .main-content {
      flex: 1;
      min-width: 300px;
    }
    #dashboard {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    #dashboard h2 {
      font-size: 1.4rem;
      margin-bottom: 10px;
    }
    #dashboard p {
      font-size: 1rem;
      color: #666;
    }
    /* Selected Course Container */
    #selectedCourseContainer {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      display: none;
    }
    #selectedCourseContainer div {
      margin-bottom: 10px;
      font-size: 1rem;
      color: #444;
    }
    /* Checkout Button */
    .checkout-button {
      display: inline-block;
      background-color: #6c63ff;
      color: #fff;
      padding: 12px 20px;
      font-size: 0.95rem;
      font-weight: bold;
      border-radius: 4px;
      text-decoration: none;
      transition: background 0.3s ease;
      margin-top: 10px;
    }
    .checkout-button:hover {
      background-color: #5548d1;
    }
    /* Form styles */
    #courseFormContainer form div {
      margin-bottom: 10px;
    }
    #courseFormContainer form label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    #courseFormContainer form input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #courseFormContainer form button {
      background-color: #6c63ff;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
    }
    #courseFormContainer form button:hover {
      background-color: #5548d1;
    }
    /* Success card */
    .success-card {
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #e6f7e6;
      text-align: center;
    }
    .success-card h3 {
      margin-bottom: 10px;
    }
    /* Right Sidebar */
    .sidebar-right {
      width: 300px;
      height: fit-content;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
    }
    .sidebar-right h3 {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 15px;
    }
    .goal-section, .timeline-section, .dashboard-info {
      margin-bottom: 20px;
    }
    .goal-section button {
      background-color: #6c63ff;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .goal-section button:hover {
      background-color: #5548d1;
    }
    .timeline-list {
      list-style: none;
      font-size: 0.9rem;
      color: #555;
    }
    .timeline-list li {
      margin-bottom: 8px;
    }
    /* User Menu (Profile) */
    .user-menu {
      position: absolute;
      top: 60px;
      right: 20px;
      width: 220px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      display: none;
      flex-direction: column;
      padding: 15px;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .user-menu.active {
      display: flex;
    }
    .user-menu div {
      margin-bottom: 10px;
      font-size: 0.9rem;
      font-weight: 500;
      color: #333;
    }
    .user-menu button {
      color: #fff;
      background-color: #6c63ff;
      padding: 8px;
      border-radius: 4px;
      font-size: 0.9rem;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    .user-menu button:hover {
      background-color: #5548d1;
    }
    /* Status Messages */
    #statusMessage, #formStatusMessage {
      margin: 10px 0;
      color: #555;
      font-size: 0.9rem;
    }
    @media screen and (max-width: 992px) {
      .container {
        flex-direction: column;
      }
      .sidebar-left, .sidebar-right {
        width: 100%;
        margin-bottom: 20px;
      }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header>
    <div class="header-left">
      <a href="#" class="logo">TaiStat</a>
      <div class="search-bar">
        <input type="text" placeholder="Search" />
        <i class="bi bi-search"></i>
      </div>
    </div>
    <div class="profile-icon" id="profileIcon">Me</div>
  </header>

  <!-- User Menu -->
  <div class="user-menu" id="userMenu">
    <div>First Name: <span id="loggedUserFName"></span></div>
    <div>Last Name: <span id="loggedUserLName"></span></div>
    <div>Email: <span id="loggedUserEmail"></span></div>
    <button id="logout">Logout</button>
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Left Sidebar: Courses List -->
    <div class="sidebar-left">
      <h3>Courses</h3>
      <ul>
        <li>Fundamentals in Python</li>
        <li>Data Science in Python</li>
        <li>Data Analysis in R</li>
        <li>Basic Excel</li>
        <li>Advanced Excel</li>
        <li>SPSS</li>
        <li>SQL</li>
        <li>STATA</li>
        <li>SAS</li>
        <li>Data Visualization using Tableau</li>
        <li>Data Visualization using PowerBI</li>
      </ul>
    </div>

    <!-- Main Content / Dashboard -->
    <div class="main-content">
      <!-- Dashboard Greeting -->
      <div id="dashboard">
        <h2>Welcome, <span id="userFirstName"></span>!</h2>
        <p>Your selected course details are shown below.</p>
      </div>

      <!-- Selected Course Container -->
      <div id="selectedCourseContainer">
        <div><strong>Course Name:</strong> <span id="courseName"></span></div>
        <div><strong>Price:</strong> <span id="coursePrice"></span></div>
        <!-- Action container will host either the checkout button or the prefilled form -->
        <div id="actionContainer"></div>
        <div id="statusMessage"></div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="sidebar-right">
      <div class="goal-section">
        <h3>Weekly Goal Progress Tracker</h3>
        <p>Set a weekly goal and track your progress.</p>
        <button>Set your weekly goal</button>
      </div>
      <div class="timeline-section">
        <h3>Course Timeline</h3>
        <ul class="timeline-list">
          <li>Start Date: Jan 15, 2025</li>
          <li>Next Milestone: Feb 25, 2025</li>
          <li>End Date: Mar 10, 2025</li>
        </ul>
      </div>
      <div class="dashboard-info">
        <h3>Your Courses</h3>
        <div id="userCourses"></div>
      </div>
    </div>
  </div>

  <!-- Firebase & App Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
    import { getFirestore, getDoc, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD6xgrttBIm9vw07xRltKsqHZNpS1jJ8xw",
      authDomain: "taistat-f0e1d.firebaseapp.com",
      projectId: "taistat-f0e1d",
      storageBucket: "taistat-f0e1d.firebasestorage.app",
      messagingSenderId: "196742294604",
      appId: "1:196742294604:web:715fe57bf6471221b898e9"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore();

    // Payment URL for Basic Excel course
    const paymentUrl = "https://payment.intasend.com/pay/c1582709-fc7a-4b88-95b2-6d63a34bd836/";

    // Handle authenticated user and load data
    onAuthStateChanged(auth, (user) => {
      const loggedInUserId = localStorage.getItem('loggedInUserId');
      if (loggedInUserId) {
        const docRef = doc(db, "users", loggedInUserId);
        getDoc(docRef)
          .then((docSnap) => {
            if (docSnap.exists()) {
              const userData = docSnap.data();
              // Update profile and dashboard info
              document.getElementById('loggedUserFName').innerText = userData.firstName;
              document.getElementById('loggedUserLName').innerText = userData.lastName;
              document.getElementById('loggedUserEmail').innerText = userData.email;
              document.getElementById('userFirstName').innerText = userData.firstName;

              // Load selected course details from session storage
              const selectedCourse = JSON.parse(sessionStorage.getItem('selectedCourse'));
              if (selectedCourse) {
                document.getElementById('courseName').innerText = selectedCourse.name;
                document.getElementById('coursePrice').innerText = `Ksh ${selectedCourse.price}`;
                document.getElementById('selectedCourseContainer').style.display = 'block';

                const actionContainer = document.getElementById('actionContainer');
                // If the course is "Basic Excel", display the checkout button
                if (selectedCourse.name === "Basic Excel") {
                  const checkoutButton = document.createElement("a");
                  checkoutButton.className = "checkout-button";
                  if (userData.paymentStatus === "paid") {
                    checkoutButton.innerText = "Go to Course";
                    checkoutButton.href = "excel.html";
                  } else {
                    checkoutButton.innerText = `Continue to Checkout for ${selectedCourse.name} course`;
                    checkoutButton.href = "#";
                    checkoutButton.addEventListener("click", initiatePayment);
                  }
                  actionContainer.appendChild(checkoutButton);
                } else {
                  // For any other course, display a prefilled form with course/user details and prompt for phone number.
                  const formContainer = document.createElement("div");
                  formContainer.id = "courseFormContainer";
                  formContainer.innerHTML = `
                    <form id="courseForm">
                      <div>
                        <label for="courseNameInput">Course Name:</label>
                        <input type="text" id="courseNameInput" name="courseName" readonly />
                      </div>
                      <div>
                        <label for="coursePriceInput">Price:</label>
                        <input type="text" id="coursePriceInput" name="coursePrice" readonly />
                      </div>
                      <div>
                        <label for="userName">Name:</label>
                        <input type="text" id="userName" name="userName" readonly />
                      </div>
                      <div>
                        <label for="userEmail">Email:</label>
                        <input type="email" id="userEmail" name="userEmail" readonly />
                      </div>
                      <div>
                        <label for="phoneNumber">Phone Number:</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="Enter phone number" required />
                      </div>
                      <button type="submit">Submit</button>
                      <div id="formStatusMessage"></div>
                    </form>
                  `;
                  actionContainer.appendChild(formContainer);
                  // Pre-fill the form fields
                  document.getElementById('courseNameInput').value = selectedCourse.name;
                  document.getElementById('coursePriceInput').value = `Ksh ${selectedCourse.price}`;
                  document.getElementById('userName').value = userData.firstName + " " + userData.lastName;
                  document.getElementById('userEmail').value = userData.email;
                  
                  // Handle form submission by sending data to your Google Form endpoint
                  const courseForm = document.getElementById('courseForm');
                  courseForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const courseName = document.getElementById('courseNameInput').value;
                    const coursePrice = document.getElementById('coursePriceInput').value;
                    const userName = document.getElementById('userName').value;
                    const userEmail = document.getElementById('userEmail').value;
                    const phoneNumber = document.getElementById('phoneNumber').value;
                    
                    // Build the Google Form submission URL.
                    // Note: We use the "formResponse" endpoint and append the input values.
                    const googleFormUrl = `https://docs.google.com/forms/d/e/1FAIpQLSehBw52_vPa1-i0wL60kj3dtxnQ-HhI9xIIKQKqyQ7IPzNkng/formResponse?entry.209269190=${encodeURIComponent(courseName)}&entry.2146804248=${encodeURIComponent(coursePrice)}&entry.1924829972=${encodeURIComponent(userName)}&entry.1885147729=${encodeURIComponent(userEmail)}&entry.803281395=${encodeURIComponent(phoneNumber)}`;
                    
                    // Submit the form data using a GET request with no-cors mode.
                    fetch(googleFormUrl, { method: "GET", mode: "no-cors" })
                      .then(() => {
                        // Remove the form and display a success card.
                        const formContainer = document.getElementById('courseFormContainer');
                        formContainer.innerHTML = `
                          <div class="success-card">
                            <h3>Enrollment Successful!</h3>
                            <p>You have enrolled into the ${courseName} course and you will be contacted shortly with the next steps.</p>
                          </div>
                        `;
                      })
                      .catch(error => {
                        document.getElementById('formStatusMessage').innerText = "There was an error submitting the form. Please try again.";
                      });
                  });
                }
                // Update dashboard "Your Courses" info
                document.getElementById('userCourses').innerText = selectedCourse.name;
              } else {
                // If no course is selected, prompt the user to select one.
                document.getElementById('selectedCourseContainer').innerHTML = "<p>Please select a course from the left sidebar.</p>";
                document.getElementById('selectedCourseContainer').style.display = 'block';
              }
            } else {
              console.log("No document found matching ID");
            }
          })
          .catch((error) => {
            console.error("Error getting document:", error);
          });
      } else {
        console.log("User ID not found in Local Storage");
      }
    });

    // Function to initiate payment for Basic Excel course
    function initiatePayment(e) {
      e.preventDefault();
      let paymentWindow = window.open(paymentUrl, "IntaSend Payment", "width=600,height=700");
      if (!paymentWindow) {
        alert("Popup blocked! Please allow popups for this site.");
        return;
      }
      document.getElementById("statusMessage").innerText = "Waiting for payment...";
      let checkPopup = setInterval(async () => {
        if (paymentWindow.closed) {
          clearInterval(checkPopup);
          document.getElementById("statusMessage").innerText = "Payment window closed.";
          return;
        }
        try {
          if (paymentWindow.location.href.includes("https://taistat-firm.com/excel.html")) {
            clearInterval(checkPopup);
            paymentWindow.close();
            await updatePaymentStatus(localStorage.getItem('loggedInUserId'));
            document.getElementById("statusMessage").innerText = "Payment successful! Redirecting...";
            setTimeout(() => {
              window.location.href = "excel.html";
            }, 2000);
          }
        } catch (error) {
          // Ignore cross-origin errors
        }
      }, 1000);
    }

    // Function to update payment status in Firestore
    async function updatePaymentStatus(userId) {
      const docRef = doc(db, "users", userId);
      await setDoc(docRef, { paymentStatus: "paid", paymentMethod: "IntaSend" }, { merge: true });
    }

    // Restrict direct access to excel.html
    if (window.location.pathname.includes("excel.html")) {
      restrictAccess();
    }
    async function restrictAccess() {
      let userId = localStorage.getItem('loggedInUserId');
      if (!userId) {
        window.location.href = "index.html";
        return;
      }
      const docRef = doc(db, "users", userId);
      const docSnap = await getDoc(docRef);
      if (!docSnap.exists() || docSnap.data().paymentStatus !== "paid") {
        window.location.href = paymentUrl;
      }
    }

    // Toggle User Menu
    const profileIcon = document.getElementById('profileIcon');
    const userMenu = document.getElementById('userMenu');
    profileIcon.addEventListener('click', () => {
      userMenu.classList.toggle('active');
    });

    // Logout functionality
    const logoutButton = document.getElementById('logout');
    logoutButton.addEventListener('click', () => {
      localStorage.removeItem('loggedInUserId');
      signOut(auth)
        .then(() => {
          window.location.href = 'login.html';
        })
        .catch((error) => {
          console.error('Error signing out:', error);
        });
    });
  </script>
</body>
</html>
